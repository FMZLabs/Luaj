<project default="all">
	<property file="version.properties"/>

	<property name="jar.name.j2me" value="luaj-j2me-${version}.jar"/>
	<property name="jar.name.j2se" value="luaj-j2se-${version}.jar"/>
	<property name="jar.name.script" value="luaj-script-${version}.jar"/>
	
	<target name="clean">
		<delete dir="build"/>
		<delete>
		    <fileset dir="." includes="luaj-*.jar"/>
		</delete>
	</target>
	
	<target name="compile" depends="wtk-or-fail">
		<mkdir dir="build/core/classes"/>
		<mkdir dir="build/j2me/classes"/>
		<mkdir dir="build/j2se/classes"/>
		<mkdir dir="build/script/classes"/>
		<javac destdir="build/core/classes" encoding="utf-8" source="1.3" target="1.1">
			<src path="src/core"/>
			<src path="src/debug"/>
		</javac>
		<javac destdir="build/j2me/classes" encoding="utf-8" source="1.3" target="1.1">
			<classpath>
				<pathelement location="build/core/classes"/>
				<pathelement path="${wtk.home}/lib/cldcapi11.jar"/>
				<pathelement path="${wtk.home}/lib/midpapi20.jar"/>
				<pathelement path="${wtk.home}/lib/mmapi.jar"/>
			</classpath>
			<src path="src/j2me"/>
		</javac>
		<javac destdir="build/j2se/classes" encoding="utf-8" source="1.3" target="1.1">
			<classpath path="build/core/classes"/>
			<src path="src/j2se"/>
		</javac>
		<javac destdir="build/script/classes" encoding="utf-8" source="1.6" target="1.6">
			<classpath>
		        <pathelement location="build/core/classes/"/>
		        <pathelement location="build/j2se/classes/"/>
			</classpath>
			<src path="src/script"/>
		</javac>
	</target>
	
	<target name="jar-j2me" depends="compile">
		<jar destfile="${jar.name.j2me}">
			<fileset dir="build/core/classes"/>
			<fileset dir="build/j2me/classes"/>
		</jar>
	</target>
	
	<target name="jar-j2se" depends="compile">
		<jar destfile="${jar.name.j2se}">
			<fileset dir="build/core/classes"/>
			<fileset dir="build/j2se/classes"/>
		</jar>
	</target>
	
	<target name="jar-script" depends="compile">
		<jar destfile="${jar.name.script}">
			<fileset dir="build/core/classes"/>
			<fileset dir="build/j2se/classes"/>
			<fileset dir="build/script/classes"/>
		    <fileset dir="src/script">
				<include name="META-INF/**"/>
		    </fileset>		
		</jar>
	</target>
	
	<target name="load-env">
		<property environment="env"/>
	</target>
	
	<target name="try-default-wtk-path" depends="load-env" unless="env.WTK_HOME">
		<available property="env.WTK_HOME" value="c:\WTK-2.2" file="c:\WTK-2.2\lib\cldcapi11.jar"/>
		<available property="env.WTK_HOME" value="/opt/WTK2.2" file="/opt/WTK2.2/lib/cldcapi11.jar"/>
	</target>
	
	<target name="find-wtk" depends="try-default-wtk-path" unless="wtk.home" if="env.WTK_HOME">
		<property name="wtk.home" value="${env.WTK_HOME}"/>
	</target>
	
	<target name="wtk-or-fail" depends="find-wtk">
		<fail unless="wtk.home" message="Sun Wireless Toolkit required to build component jars."/>
		<echo>Using WTK found in ${wtk.home}</echo>
	</target>

	<target name="dist">
		<delete dir="build/luaj-${version}"/>
		<mkdir dir="build/luaj-${version}/src"/>
		<mkdir dir="build/luaj-${version}/lib"/>
		<copy todir="build/luaj-${version}/src">
		    <fileset dir="src"/>
		</copy>
		<copy todir="build/luaj-${version}/lib">
		    <fileset dir=".">
				<include name="*-${version}.jar"/>
		    </fileset>		
		</copy>
		<copy todir="build/luaj-${version}">
		    <fileset dir=".">
				<include name="build.xml"/>
				<include name="version.properties"/>
		    </fileset>		
		</copy>
		<zip destfile="luaj-${version}.zip" 
			basedir="build" includes="luaj-${version}/**"/>
	</target>
	
	<target name="all" depends="clean,jar-j2me,jar-j2se,jar-script"/>
</project>
