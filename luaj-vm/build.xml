<project default="all">
	<property file="version.properties"/>
	
	<property environment="env"/>
	
	<property name="jar.name.jme" value="luaj-jme-${version}.jar"/>
	<property name="jar.name.jse" value="luaj-jse-${version}.jar"/>

	<import file="wtk.xml"/>
	
	<property name="antlr.version"     value="3.1.3"/>
	<property name="antlr.home"        value="${env.ANTLR_HOME}"/>
	<property name="antlr.tool.jar"    value="${antlr.home}/lib/antlr-${antlr.version}.jar"/>
	<property name="antlr.runtime.jar" value="${antlr.home}/lib/antlr-runtime-${antlr.version}.jar"/>
	<property name="grammar.dir"       value="src/jse/org/luaj/vm2/luajc/antlr"/>	
	<property name="grammar.name"      value="Lua"/>	

	<target name="clean">
		<delete dir="build"/>
		<delete>
		    <fileset dir="." includes="luaj-*.jar"/>
		</delete>
	</target>
	
	<target name="generate">
		<fail unless="env.ANTLR_HOME" message="ANTLR_HOME must be set."/>
	        <available file="${antlr.tool.jar}" property="antlr.tool.exists"/>
		<fail unless="antlr.tool.exists" message="ANTLR tool not found: ${antlr.tool.jar}"/>
		<echo>Generating files using ${antlr.tool.jar}</echo>
		<java classpath="${antlr.tool.jar}" 
			classname="org.antlr.Tool" 
			dir="${grammar.dir}" 
			fork="true"
			failonerror="true">
			<arg line="${grammar.name}.g"/>
		</java>
	</target>
		
	<target name="compile" depends="wtk-or-fail">
		<mkdir dir="build/core/src"/>
		<mkdir dir="build/core/classes"/>
		<mkdir dir="build/jme/classes"/>
		<mkdir dir="build/jse/classes"/>
		<copy todir="build/core/src">
			<fileset dir="src/core"/>
			<filterchain>
				<tokenfilter>
			  	    <replacestring from='"Luaj 0.0"' to='"Luaj ${version}"'/>
				</tokenfilter>
			</filterchain>
		</copy>
		<javac destdir="build/core/classes" encoding="utf-8" source="1.3" target="1.2" bootclasspathref="wtk-libs">
			<src path="build/core/src"/>
		</javac>
		<javac destdir="build/jme/classes" encoding="utf-8" source="1.3" target="1.2" bootclasspathref="wtk-libs">
			<classpath path="build/core/classes"/>
			<src path="src/jme"/>
		</javac>
		<javac destdir="build/jse/classes" encoding="utf-8" source="1.5" target="1.5">
			<classpath path="build/core/classes;${antlr.runtime.jar}"/>
			<src path="src/jse"/>
		</javac>
	</target>
	
	<target name="jar-jme" depends="compile">
		<jar destfile="${jar.name.jme}">
			<fileset dir="build/core/classes"/>
			<fileset dir="build/jme/classes"/>
		</jar>
	</target>
	
	<target name="jar-jse" depends="compile">
		<jar destfile="${jar.name.jse}">
			<fileset dir="build/core/classes"/>
			<fileset dir="build/jme/classes"/>
			<fileset dir="build/jse/classes"/>
		    <fileset dir="src/jse/">
				<include name="META-INF/**"/>
		    </fileset>		
		</jar>
	</target>

	<target name="doc">
		<delete dir="docs/api"/>
		<mkdir dir="docs/api"/>
		<javadoc packagenames="org.luaj.vm2.*"
				sourcepath="src/core"
				defaultexcludes="yes"
				destdir="docs/api"
				author="true"
				version="true"
				use="true"
				windowtitle="Luaj API">
			<doctitle><![CDATA[<h1>Luaj API</h1>]]></doctitle>
			<bottom><![CDATA[<i>Copyright &#169; 2007-2008 Luaj.org. All Rights Reserved.</i>]]></bottom>
			<tag name="todo" scope="all" description="To do:"/>
			<group title="Core VM" packages="org.luaj.vm.*"/>
			<link offline="true" href="http://sourceforge.net/projects/luaj/" packagelistLoc="C:\tmp"/>
			<link href="http://sourceforge.net/projects/luaj/"/>
		</javadoc>
	</target>
	
	<target name="dist" depends="all">
		<delete dir="build/luaj-${version}"/>
		<mkdir dir="build/luaj-${version}/src"/>
		<mkdir dir="build/luaj-${version}/lib"/>
		<copy todir="build/luaj-${version}/src">
		    <fileset dir="src">
				<exclude name="src/test/**"/>
		    </fileset>
		</copy>
		<copy todir="build/luaj-${version}/test">
		    <fileset dir="test"/>
		</copy>
		<copy todir="build/luaj-${version}/examples">
		    <fileset dir="examples"/>
		</copy>
		<copy todir="build/luaj-${version}/lib">
		    <fileset dir=".">
				<include name="*-${version}.jar"/>
		    </fileset>		
		</copy>
		<copy todir="build/luaj-${version}">
		    <fileset dir=".">
				<include name="build.xml"/>
				<include name="build-coverage.xml"/>
				<include name="version.properties"/>
				<include name="wtk.xml"/>
				<include name="README.html"/>
				<include name="names.csv"/>
				<include name=".classpath"/>
				<include name=".project"/>
		    </fileset>		
		</copy>
		<zip destfile="luaj-${version}.zip" 
			basedir="build" includes="luaj-${version}/**"/>
	</target>
	
	<target name="all" depends="clean,jar-jme,jar-jse"/>
		
</project>
